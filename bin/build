#!/usr/bin/env bash

################################################################################
# NOTE: This build script starts with utility functions... you probably 
#     want to scroll down to the "name the files to include" section 
################################################################################

# This will eventually be replaced with $1 so you can specify which title
# to build at the command line
TITLE="EW"

cd $(dirname $0)
cd ..

BUILDROOT=$(pwd)

# JSFILES are arrays of javascript files that are used in the site we're
# currently building. when we generate the site, this array is used to 
# concatenate/minify the javascript.
dev_js_file() {
  DEVJSFILES=("${DEVJSFILES[@]}" $1)
}
prod_js_file() {
  PRODJSFILES=("${PRODJSFILES[@]}" $1)
}
js_file() {
  dev_js_file $1
  prod_js_file $1
}
js_lib() {
  cp "lib/$1" "$DEVDIR/lib/$1"
  js_file "lib/$1"
}
dev_lib() {
  cp "lib/$1" "$DEVDIR/lib/$1"
  div_js_file "lib/$1"
}
prod_lib() {
  cp "lib/$1" "$DEVDIR/lib/$1"
  prod_js_file "lib/$1"
}
templates() {
  cd $DEVDIR
  for TMPL in $(ls $1)
  do
    handlebars "$TMPL" --output "$TMPL.js"
    js_file "$TMPL.js"
  done
  cd $BUILDROOT
}
building() {
  BUILDING=$1
  DEVDIR=$BUILDING-dev
  DEPLOYDIR=$BUILDING-deploy
  DEVJSFILES=()
  PRODJSFILES=()
  rm -r $DEVDIR
  rm -r $DEPLOYDIR
  cp -a $BUILDING $DEVDIR
  mkdir $DEVDIR/lib
}
compile() {
  compass compile "$DEVDIR/styles/"
  mv "$DEVDIR/css/$TITLE.css" "$DEVDIR/css/main.css"

  # render the index.html.tmpl file
  python bin/render_index.py "$DEVDIR/index.html.tmpl" "$DEVDIR/index.dev.html" ${DEVJSFILES[@]}
  python bin/render_index.py "$DEVDIR/index.html.tmpl" "$DEVDIR/index.prod.html" ${PRODJSFILES[@]}
  
  cp -a $DEVDIR $DEPLOYDIR
  mv $DEPLOYDIR/index.prod.html $DEPLOYDIR/index.html
  rm -r $DEPLOYDIR/styles
  rm $DEPLOYDIR/index.dev.html
}

################################################################################
# name the files to include
################################################################################

building 'store'

prod_lib 'AdobeLibraryAPI.js'
js_lib 'jquery.js'
js_lib 'moment.js'
js_lib 'underscore.js'
js_lib 'backbone.js'
js_lib 'handlebars.runtime.js'

dev_lib 'tcm_devtools.js'

templates 'templates/*.tmpl'


# app specific
js_file "settings/$TITLE.js"
js_file 'settings/settings_loader.js'

# requires settings to be loaded
js_lib 's_code.js'
js_lib 'tcm_omniture.js'

js_file "src/views/welcome.js"
js_file "src/main.js"

compile

