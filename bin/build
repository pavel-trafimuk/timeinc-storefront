#!/usr/bin/env bash

################################################################################
# NOTE: This build script starts with utility functions... you probably 
#     want to scroll down to the "name the files to include" section 
################################################################################

# This will eventually be replaced with $1 so you can specify which title
# to build at the command line
if [ -z "$1" ]; then
  TITLE="EW"
else
  TITLE="$1"
fi

cd $(dirname $0)
cd ..

BUILDROOT=$(pwd)

# JSFILES are arrays of javascript files that are used in the site we're
# currently building. when we generate the site, this array is used to 
# concatenate/minify the javascript.
dev_js_file() {
  DEVJSFILES=("${DEVJSFILES[@]}" $1)
}
prod_js_file() {
  PRODJSFILES=("${PRODJSFILES[@]}" $1)
}
js_file() {
  dev_js_file $1
  prod_js_file $1
}
js_files() {
  cd $DEVDIR
  for JSFILE in $(ls $1); do
    js_file $JSFILE
  done
  cd $BUILDROOT
}
js_lib() {
  cp "lib/$1" "$DEVDIR/lib/$1"
  js_file "lib/$1"
}
dev_lib() {
  cp "lib/$1" "$DEVDIR/lib/$1"
  dev_js_file "lib/$1"
}
prod_lib() {
  cp "lib/$1" "$DEVDIR/lib/$1"
  prod_js_file "lib/$1"
}
template() {
  handlebars "$1" --output "$1.js"
  js_file "$1.js"
}
templates() {
  cd $DEVDIR
  for TMPL in $(ls $1); do
    template $TMPL 
  done
  cd $BUILDROOT
}
building() {
  BUILDING=$1
  DEVDIR=$TITLE-$BUILDING-dev
  DEPLOYDIR=$TITLE-$BUILDING-deploy
  DEVJSFILES=()
  PRODJSFILES=()
  rm -r $DEVDIR
  rm -r $DEPLOYDIR
  cp -a $BUILDING $DEVDIR
  mkdir $DEVDIR/lib
}
compile() {
  compass compile "$DEVDIR/styles/"
  mv "$DEVDIR/css/$TITLE.css" "$DEVDIR/css/main.css"

  # render the index.html.tmpl file
  python bin/render_index.py "$DEVDIR/index.html.tmpl" "$DEVDIR/index.mockapi.dev.html" ${DEVJSFILES[@]}
  python bin/render_index.py "$DEVDIR/index.html.tmpl" "$DEVDIR/index.dev.html" "lib/AdobeLibraryAPI.js" ${DEVJSFILES[@]}
  
  mv $DEVDIR/index.dev.html $DEVDIR/index.html

  mkdir $DEPLOYDIR
  
  # minify js
  cd $DEVDIR
  cat ${PRODJSFILES[@]} | uglifyjs > $BUILDROOT/$DEPLOYDIR/main.min.js
  cd $BUILDROOT

  # copy css and assets
  mkdir $DEPLOYDIR/css
  cp $DEVDIR/css/main.css $DEPLOYDIR/css/main.css
  cp -r $DEVDIR/images $DEPLOYDIR/images
  
  python bin/render_index.py "$DEVDIR/index.html.tmpl" "$DEVDIR/index.prod.html" "main.min.js?v=$(md5 -q $BUILDROOT/$DEPLOYDIR/main.min.js)"
  cp $DEVDIR/index.prod.html $DEPLOYDIR/index.html
}

################################################################################
# name the files to include
################################################################################

building 'store'

prod_lib 'AdobeLibraryAPI.js'
dev_lib 'MockAPI.js'

js_lib 'APIWrapper.js'
js_lib 'async.js'
js_lib 'jquery.js'
js_lib 'moment.js'
js_lib 'underscore.js'
js_lib 'backbone.js'
js_lib 'handlebars.runtime.js'

dev_lib 'tcm_devtools.js'

templates 'templates/*.tmpl'


# app specific
js_file "settings/$TITLE.js"
js_file 'settings/settings_loader.js'

# requires settings to be loaded
js_lib 's_code.js'
js_lib 'tcm_omniture.js'

# creates App object (which is just a namespace)
js_file "src/app.js"

js_files "src/views/*.js"

# kicks off the app
js_file "src/main.js"

compile

